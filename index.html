<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Explorer | AI-Powered Psychological Test</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --info: #0984e3;
            --border-radius: 12px;
            --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f6fa;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: var(--secondary);
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .test-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .question-container {
            margin-bottom: 2rem;
            min-height: 120px;
            display: flex;
            align-items: center;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--dark);
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .option-btn {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            font-size: 1rem;
        }

        .option-btn:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background-color: rgba(108, 92, 231, 0.1);
        }

        .nav-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #5a4bd1;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-container {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.5s ease;
        }

        .result-title {
            color: var(--primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .result-level {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }

        .level-mild {
            color: var(--success);
            background-color: rgba(0, 184, 148, 0.1);
        }

        .level-moderate {
            color: var(--warning);
            background-color: rgba(253, 203, 110, 0.1);
        }

        .level-severe {
            color: var(--danger);
            background-color: rgba(214, 48, 49, 0.1);
        }

        .level-critical {
            color: white;
            background-color: var(--danger);
        }

        .result-content {
            margin-bottom: 2rem;
        }

        .music-recommendations {
            background-color: rgba(152, 128, 255, 0.1);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 1.5rem;
        }

        .music-title {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .music-list {
            list-style-type: none;
        }

        .music-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .music-item:last-child {
            border-bottom: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(108, 92, 231, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        footer {
            text-align: center;
            padding: 1rem;
            color: var(--dark);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .test-container, .result-container {
                padding: 1.5rem;
            }
            
            .question-text {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
        }

        /* Animation for question transition */
        .fade-out {
            animation: fadeOut 0.3s ease;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TEST TÂM LÝ </h1>
            <p class="subtitle">made by Khoa Dev | Đảm bảo kết quả chính xác đạt 99%</p>
        </header>

        <div class="test-container" id="testContainer">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p class="progress-text" id="progressText">Question 1 of 21</p>
            
            <div class="question-container">
                <p class="question-text" id="questionText">Loading first question...</p>
            </div>
            
            <div class="options-container" id="optionsContainer">
                <!-- Options will be dynamically inserted here -->
            </div>
            
            <div class="nav-btns">
                <button class="btn btn-secondary" id="resetBtn">Kiểm tra lại</button>
                <button class="btn btn-primary" id="nextBtn" disabled>Tiếp theo</button>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>[KHOA AI] Đang phân tích kết quả dựa trên câu trả lời của bạn...</p>
        </div>

        <div class="result-container" id="resultContainer">
            <h2 class="result-title">Đánh giá tâm lý của bạn</h2>
            <div id="resultLevel" class="result-level"></div>
            <div class="result-content" id="resultContent"></div>
            <div class="music-recommendations">
                <h3 class="music-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Đề xuất âm nhạc
                </h3>
                <ul class="music-list" id="musicList"></ul>
            </div>
            <button class="btn btn-primary" id="restartBtn" style="margin-top: 1.5rem; width: 100%;">Làm lại bài kiểm tra</button>
        </div>
    </div>

    <footer>
        <p>© 2025 KHOA AI TEST TÂM LÝ | Thông tin chi tiết về tâm lý được hỗ trợ bởi AI</p>
    </footer>

    <script>
        // Configuration
        const TOTAL_QUESTIONS = 21;
        const API_KEY = "AIzaSyCOFBRKmDGipgq3cX2aI_74NfSfjZ_bYtE";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        
        // DOM Elements
        const testContainer = document.getElementById('testContainer');
        const resultContainer = document.getElementById('resultContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const nextBtn = document.getElementById('nextBtn');
        const resetBtn = document.getElementById('resetBtn');
        const restartBtn = document.getElementById('restartBtn');
        const resultLevel = document.getElementById('resultLevel');
        const resultContent = document.getElementById('resultContent');
        const musicList = document.getElementById('musicList');
        
        // State variables
        let currentQuestionIndex = 0;
        let userResponses = [];
        let questions = [];
        let selectedOption = null;
        
        // Initialize the test
        function initTest() {
            // Check if there's saved progress
            const savedProgress = localStorage.getItem('mindExplorerProgress');
            
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                currentQuestionIndex = progress.currentQuestionIndex;
                userResponses = progress.userResponses;
                questions = progress.questions;
                
                // If we have questions but not enough for the current index, reset
                if (questions.length <= currentQuestionIndex && currentQuestionIndex > 0) {
                    resetTest();
                    return;
                }
                
                updateProgress();
                if (questions.length > currentQuestionIndex) {
                    displayQuestion(questions[currentQuestionIndex]);
                } else {
                    generateQuestion();
                }
            } else {
                resetTest();
            }
        }
        
        // Reset the test
        function resetTest() {
            currentQuestionIndex = 0;
            userResponses = [];
            questions = [];
            selectedOption = null;
            
            localStorage.removeItem('mindExplorerProgress');
            updateProgress();
            generateQuestion();
        }
        
        // Update progress bar and text
        function updateProgress() {
            const progressPercentage = (currentQuestionIndex / TOTAL_QUESTIONS) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            progressText.textContent = `Question ${currentQuestionIndex + 1} of ${TOTAL_QUESTIONS}`;
        }
        
        // Display question
        function displayQuestion(question) {
            // Add fade-out animation
            questionText.classList.add('fade-out');
            optionsContainer.classList.add('fade-out');
            
            setTimeout(() => {
                questionText.textContent = question.text;
                
                // Clear previous options
                optionsContainer.innerHTML = '';
                
                // Add new options
                question.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option;
                    optionBtn.dataset.index = index;
                    
                    optionBtn.addEventListener('click', () => selectOption(optionBtn, index));
                    
                    optionsContainer.appendChild(optionBtn);
                });
                
                // Remove fade-out and add fade-in animation
                questionText.classList.remove('fade-out');
                optionsContainer.classList.remove('fade-out');
                questionText.classList.add('fade-in');
                optionsContainer.classList.add('fade-in');
                
                setTimeout(() => {
                    questionText.classList.remove('fade-in');
                    optionsContainer.classList.remove('fade-in');
                }, 300);
                
                // Reset selected option
                selectedOption = null;
                nextBtn.disabled = true;
            }, 300);
        }
        
        // Select an option
        function selectOption(optionBtn, index) {
            // Deselect all options
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select clicked option
            optionBtn.classList.add('selected');
            selectedOption = index;
            nextBtn.disabled = false;
        }
        
        // Generate a new question using AI
        async function generateQuestion() {
            try {
                nextBtn.disabled = true;
                optionsContainer.innerHTML = '';
                questionText.textContent = 'KHOA AI - Đang tạo câu hỏi...';
                
                // Prepare the prompt for the AI
                let prompt = `Tạo một câu hỏi đánh giá tâm lý với 4 lựa chọn trả lời. `;
                
                if (userResponses.length > 0) {
                    prompt += `Dựa trên các phản hồi trước đó của người dùng:`;
                    
                    // Include previous questions and answers for context
                    for (let i = 0; i < userResponses.length; i++) {
                        prompt += `Đối với câu hỏi "${questions[i].text}", họ đã chọn "${questions[i].options[userResponses[i]]}". `;
                    }
                    
                    prompt += `Câu hỏi tiếp theo tự nhiên sẽ theo sau quỹ đạo cảm xúc và tâm lý này. `;
                }
                
                prompt += `Câu hỏi nên khám phá một trong những khía cạnh tâm lý sau: lo lắng, căng thẳng, áp lực học tập/công việc, cô đơn, tự tin, kỳ vọng vào bản thân, mối quan hệ gia đình, mối quan hệ xã hội, sở thích cá nhân, hy vọng trong tương lai hoặc cảm xúc hiện tại.`;
                prompt += `Đảm bảo câu hỏi này khác biệt với các câu hỏi trước về nội dung và cách diễn đạt.`;
                prompt += `The answer format is as follows: Question: [question text] | Option 1: [text] | Option 2: [text] | Option 3: [text] | Option 4: [text]`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Failed to generate question');
                }
                
                // Extract the generated content
                const generatedText = data.candidates[0].content.parts[0].text;
                
                // Parse the generated text into question and options
                const questionParts = generatedText.split('|').map(part => part.trim());
                const question = {
                    text: questionParts[0].replace('Question:', '').trim(),
                    options: [
                        questionParts[1].replace('Option 1:', '').trim(),
                        questionParts[2].replace('Option 2:', '').trim(),
                        questionParts[3].replace('Option 3:', '').trim(),
                        questionParts[4].replace('Option 4:', '').trim()
                    ]
                };
                
                // Add to questions array
                questions.push(question);
                
                // Save progress
                saveProgress();
                
                // Display the question
                displayQuestion(question);
                
            } catch (error) {
                console.error('Error generating question:', error);
                questionText.textContent = 'Error generating question. Please try again.';
                setTimeout(generateQuestion, 2000);
            }
        }
        
        // Save progress to localStorage
        function saveProgress() {
            const progress = {
                currentQuestionIndex,
                userResponses,
                questions
            };
            
            localStorage.setItem('mindExplorerProgress', JSON.stringify(progress));
        }
        
        // Move to next question
        async function nextQuestion() {
            if (selectedOption === null) return;
            
            // Save user response
            userResponses.push(selectedOption);
            
            // Update progress
            currentQuestionIndex++;
            updateProgress();
            
            // Save progress
            saveProgress();
            
            // Check if test is complete
            if (currentQuestionIndex >= TOTAL_QUESTIONS) {
                completeTest();
                return;
            }
            
            // Generate next question
            await generateQuestion();
        }
        
        // Complete the test and show results
        async function completeTest() {
            // Hide test container, show loading indicator
            testContainer.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            try {
                // Prepare prompt for analysis
                let prompt = `Phân tích các phản hồi kiểm tra tâm lý này và đưa ra:\n`;
                prompt += `1. Mức độ đánh giá (Nhẹ, Trung bình, Nặng hoặc Nguy kịch)\n`;
                prompt += `2. Phân tích chi tiết trạng thái tâm lý\n`;
                prompt += `3. 5 đề xuất âm nhạc có thể giúp ích dựa trên đánh giá\n\n`;
                prompt += `Trả lời:\n`;
                
                for (let i = 0; i < userResponses.length; i++) {
                    prompt += `Q: ${questions[i].text}\nA: ${questions[i].options[userResponses[i]]}\n\n`;
                }
                
                prompt += `Định dạng câu trả lời như sau:\nĐánh giá: [mức độ]\nPhân tích: [văn bản]\nÂm nhạc: 1. [bài hát] của [nghệ sĩ]\n2. [bài hát] của [nghệ sĩ]\n...`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Failed to analyze responses');
                }
                
                // Extract the generated content
                const resultText = data.candidates[0].content.parts[0].text;
                
                // Parse the results
                const assessmentMatch = resultText.match(/Assessment:\s*(Nhẹ|Trung bình|Nặng|Nguy kịch)/i);
                const analysisMatch = resultText.match(/Analysis:\s*([\s\S]*?)(?=Music:|$)/i);
                const musicMatch = resultText.match(/Music:([\s\S]*)/i);
                
                const assessment = assessmentMatch ? assessmentMatch[1] : 'Moderate';
                const analysis = analysisMatch ? analysisMatch[1].trim() : 'The analysis could not be generated.';
                const musicText = musicMatch ? musicMatch[1] : '';
                
                // Extract music recommendations
                const musicItems = [];
                if (musicText) {
                    const musicLines = musicText.split('\n').filter(line => line.trim() && /^\d+\./.test(line.trim()));
                    musicItems.push(...musicLines.map(line => line.replace(/^\d+\.\s*/, '').trim()));
                }
                
                // Fallback music recommendations if none were generated
                if (musicItems.length === 0) {
                    musicItems.push(
                        "Weightless by Marconi Union",
                        "Clair de Lune by Claude Debussy",
                        "Strobe by Deadmau5",
                        "Sunflower by Post Malone & Swae Lee",
                        "Blinding Lights by The Weeknd"
                    );
                }
                
                // Display results
                resultLevel.textContent = assessment;
                resultLevel.className = 'result-level';
                
                // Add appropriate class based on assessment level
                if (assessment.toLowerCase() === 'mild') {
                    resultLevel.classList.add('level-mild');
                } else if (assessment.toLowerCase() === 'moderate') {
                    resultLevel.classList.add('level-moderate');
                } else if (assessment.toLowerCase() === 'severe') {
                    resultLevel.classList.add('level-severe');
                } else {
                    resultLevel.classList.add('level-critical');
                }
                
                resultContent.textContent = analysis;
                
                // Display music recommendations
                musicList.innerHTML = '';
                musicItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'music-item';
                    li.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 18V5L21 3V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="6" cy="18" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="18" cy="16" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        ${item}
                    `;
                    musicList.appendChild(li);
                });
                
                // Hide loading indicator, show results
                loadingIndicator.style.display = 'none';
                resultContainer.style.display = 'block';
                
                // Clear storage
                localStorage.removeItem('mindExplorerProgress');
                
            } catch (error) {
                console.error('Error analyzing responses:', error);
                loadingIndicator.innerHTML = '<p>Error generating results. Please try again.</p>';
                setTimeout(initTest, 3000);
            }
        }
        
        // Event listeners
        nextBtn.addEventListener('click', nextQuestion);
        resetBtn.addEventListener('click', resetTest);
        restartBtn.addEventListener('click', () => {
            resultContainer.style.display = 'none';
            testContainer.style.display = 'block';
            resetTest();
        });
        
        // Initialize the test
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>
</html>
