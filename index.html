<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc nghiệm Tâm lý AI</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --accent-color: #ff7e5f;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .question-container {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .option {
            padding: 12px 15px;
            background-color: var(--light-color);
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .option:hover {
            background-color: #e9ecef;
            border-color: var(--secondary-color);
        }
        
        .option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a8c;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #e66a4a;
        }
        
        .result-container {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: none;
        }
        
        .result-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .result-content {
            margin-bottom: 20px;
        }
        
        .music-recommendations {
            margin-top: 30px;
        }
        
        .music-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .music-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trắc nghiệm Tâm lý AI</h1>
            <p>Khám phá trạng thái tâm lý của bạn thông qua 21 câu hỏi được AI thiết kế riêng</p>
        </header>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>AI đang phân tích và tạo câu hỏi phù hợp với bạn...</p>
        </div>
        
        <div class="question-container" id="questionContainer">
            <div class="question-text" id="questionText"></div>
            <div class="options-container" id="optionsContainer"></div>
            <div class="nav-buttons">
                <button class="btn-secondary" id="resetBtn">Bắt đầu lại</button>
                <button class="btn-primary" id="nextBtn" disabled>Tiếp theo</button>
            </div>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h2 class="result-title">Kết quả đánh giá tâm lý</h2>
            <div class="result-content" id="resultContent"></div>
            <div class="music-recommendations" id="musicRecommendations">
                <h3>Gợi ý âm nhạc cho bạn</h3>
                <div id="musicList"></div>
            </div>
            <div class="nav-buttons" style="justify-content: center;">
                <button class="btn-accent" id="retakeBtn">Làm lại bài test</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>© 2023 Trắc nghiệm Tâm lý AI. Tất cả quyền được bảo lưu.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const progressBar = document.getElementById('progressBar');
    const questionContainer = document.getElementById('questionContainer');
    const resultContainer = document.getElementById('resultContainer');
    const resultContent = document.getElementById('resultContent');
    const musicList = document.getElementById('musicList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // State variables
    let currentQuestionIndex = 0;
    let answers = [];
    let questions = [];
    const totalQuestions = 21;
    const apiKey = 'AIzaSyCOFBRKmDGipgq3cX2aI_74NfSfjZ_bYtE';
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    // Initialize the test
    initTest();
    
    // Event listeners
    nextBtn.addEventListener('click', goToNextQuestion);
    resetBtn.addEventListener('click', resetTest);
    retakeBtn.addEventListener('click', resetTest);
    
    // Functions
    function initTest() {
        // Load saved progress if exists
        const savedTest = localStorage.getItem('psychologyTest');
        if (savedTest) {
            const testData = JSON.parse(savedTest);
            currentQuestionIndex = testData.currentQuestionIndex;
            answers = testData.answers;
            questions = testData.questions || [];
            
            if (currentQuestionIndex >= totalQuestions) {
                showResults();
            } else if (questions.length > currentQuestionIndex) {
                displayQuestion();
            } else {
                generateNextQuestion();
            }
        } else {
            generateNextQuestion();
        }
        
        updateProgressBar();
    }
    
    async function generateNextQuestion() {
        showLoading(true);
        
        try {
            const context = buildQuestionContext();
            const prompt = buildQuestionPrompt(context);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const data = await response.json();
            const generatedText = data.candidates[0].content.parts[0].text;
            
            // Parse the generated question and options
            const parsedQuestion = parseGeneratedQuestion(generatedText);
            questions.push(parsedQuestion);
            
            // Save progress
            saveProgress();
            
            // Display the question
            displayQuestion();
        } catch (error) {
            console.error('Error generating question:', error);
            alert('Có lỗi xảy ra khi tạo câu hỏi. Vui lòng thử lại.');
            showLoading(false);
        }
    }
    
    function buildQuestionContext() {
        if (answers.length === 0) {
            return "Đây là câu hỏi đầu tiên trong bài test. Hãy tạo một câu hỏi mở đầu nhẹ nhàng về cảm xúc hiện tại.";
        }
        
        // Build context based on previous answers
        let context = `Người dùng đã trả lời ${answers.length} câu hỏi trước đó. `;
        context += `Câu hỏi gần nhất là: "${questions[questions.length-1].text}". `;
        context += `Câu trả lời gần nhất là: "${answers[answers.length-1].answerText}". `;
        
        // Add emotional context if available
        if (answers.length >= 3) {
            const recentAnswers = answers.slice(-3);
            const positiveCount = recentAnswers.filter(a => a.answerIndex === 0 || a.answerIndex === 1).length;
            const negativeCount = recentAnswers.filter(a => a.answerIndex === 2 || a.answerIndex === 3).length;
            
            if (positiveCount > negativeCount) {
                context += "Xu hướng gần đây của người dùng là tích cực. ";
            } else if (negativeCount > positiveCount) {
                context += "Xu hướng gần đây của người dùng là tiêu cực. ";
            } else {
                context += "Xu hướng gần đây của người dùng là trung lập. ";
            }
        }
        
        context += "Hãy tạo câu hỏi tiếp theo phù hợp với mạch cảm xúc hiện tại, không trùng lặp với các câu hỏi trước.";
        
        return context;
    }
    
    function buildQuestionPrompt(context) {
        return `Bạn là một chuyên gia tâm lý đang thực hiện bài trắc nghiệm tâm lý gồm 21 câu hỏi. ${context}

        Yêu cầu:
        1. Tạo một câu hỏi trắc nghiệm tâm lý duy nhất, không trùng lặp với các câu hỏi trước.
        2. Câu hỏi phải phù hợp với mạch cảm xúc hiện tại của người dùng.
        3. Mỗi câu hỏi có 4 lựa chọn trả lời, thể hiện các mức độ từ tích cực đến tiêu cực.
        4. Câu hỏi phải tự nhiên, khai thác đa dạng chủ đề tâm lý.
        5. Định dạng câu hỏi như sau:
        
        [Câu hỏi]
        1. [Lựa chọn 1 - tích cực nhất]
        2. [Lựa chọn 2 - hơi tích cực]
        3. [Lựa chọn 3 - hơi tiêu cực]
        4. [Lựa chọn 4 - tiêu cực nhất]
        
        Ví dụ:
        Bạn cảm thấy thế nào về các mối quan hệ xã hội của mình gần đây?
        1. Rất tốt, tôi có nhiều bạn bè và luôn cảm thấy được hỗ trợ
        2. Khá tốt, mặc dù đôi khi tôi cảm thấy hơi cô đơn
        3. Không tốt lắm, tôi cảm thấy khó kết nối với người khác
        4. Rất tệ, tôi gần như không có mối quan hệ ý nghĩa nào
        
        Hãy tạo câu hỏi tiếp theo:`;
    }
    
    function parseGeneratedQuestion(text) {
        // Extract question and options from the generated text
        const lines = text.split('\n').filter(line => line.trim() !== '');
        
        // The first line is the question
        const question = lines[0].replace(/^\d+\.\s*/, '').replace(/^- /, '').trim();
        
        // The next 4 lines are options
        const options = [];
        for (let i = 1; i <= 4 && i < lines.length; i++) {
            let option = lines[i].replace(/^\d+\.\s*/, '').trim();
            options.push(option);
        }
        
        // If we didn't get 4 options, fill with defaults
        while (options.length < 4) {
            options.push(`Lựa chọn ${options.length + 1}`);
        }
        
        return {
            text: question,
            options: options
        };
    }
    
    function displayQuestion() {
        showLoading(false);
        
        const question = questions[currentQuestionIndex];
        questionText.textContent = question.text;
        
        optionsContainer.innerHTML = '';
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.classList.add('option');
            optionElement.textContent = option;
            optionElement.addEventListener('click', () => selectOption(index, optionElement));
            optionsContainer.appendChild(optionElement);
        });
        
        // Check if this question was already answered
        if (answers[currentQuestionIndex]) {
            const selectedIndex = answers[currentQuestionIndex].answerIndex;
            const options = optionsContainer.querySelectorAll('.option');
            options[selectedIndex].classList.add('selected');
            nextBtn.disabled = false;
        } else {
            nextBtn.disabled = true;
        }
        
        // Update button text for last question
        if (currentQuestionIndex === totalQuestions - 1) {
            nextBtn.textContent = 'Xem kết quả';
        } else {
            nextBtn.textContent = 'Tiếp theo';
        }
    }
    
    function selectOption(index, element) {
        // Remove selected class from all options
        const options = optionsContainer.querySelectorAll('.option');
        options.forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to clicked option
        element.classList.add('selected');
        
        // Store the answer
        if (!answers[currentQuestionIndex]) {
            answers[currentQuestionIndex] = {
                answerIndex: index,
                answerText: questions[currentQuestionIndex].options[index]
            };
            saveProgress();
        }
        
        // Enable next button
        nextBtn.disabled = false;
    }
    
    function goToNextQuestion() {
        if (!answers[currentQuestionIndex]) {
            alert('Vui lòng chọn một đáp án trước khi tiếp tục.');
            return;
        }
        
        currentQuestionIndex++;
        updateProgressBar();
        
        if (currentQuestionIndex < totalQuestions) {
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                generateNextQuestion();
            }
        } else {
            showResults();
        }
    }
    
    function updateProgressBar() {
        const progress = ((currentQuestionIndex) / totalQuestions) * 100;
        progressBar.style.width = `${progress}%`;
    }
    
    async function showResults() {
        showLoading(true);
        
        try {
            // Generate analysis based on answers
            const analysis = await generateAnalysis();
            
            // Display results
            questionContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            
            resultContent.innerHTML = `
                <h3>Mức độ tâm lý: <strong>${analysis.level}</strong></h3>
                <p>${analysis.advice}</p>
            `;
            
            // Display music recommendations
            musicList.innerHTML = '';
            analysis.musicRecommendations.forEach(song => {
                const musicItem = document.createElement('div');
                musicItem.classList.add('music-item');
                musicItem.innerHTML = `
                    <div>
                        <strong>${song.title}</strong> - ${song.artist}
                        <p><small>${song.reason}</small></p>
                    </div>
                `;
                musicList.appendChild(musicItem);
            });
            
            // Clear the test data from storage
            localStorage.removeItem('psychologyTest');
        } catch (error) {
            console.error('Error generating results:', error);
            alert('Có lỗi xảy ra khi tạo kết quả. Vui lòng thử lại.');
        } finally {
            showLoading(false);
        }
    }
    
    async function generateAnalysis() {
        // Build prompt for analysis
        let prompt = `Tôi đã hoàn thành bài trắc nghiệm tâm lý gồm 21 câu hỏi. Dưới đây là các câu hỏi và câu trả lời:\n\n`;
        
        for (let i = 0; i < questions.length; i++) {
            prompt += `Câu ${i+1}: ${questions[i].text}\n`;
            prompt += `Trả lời: ${answers[i].answerText}\n\n`;
        }
        
        prompt += `Hãy phân tích các câu trả lời và đưa ra đánh giá tâm lý theo các yêu cầu sau:
        1. Xác định mức độ tâm lý (chỉ chọn một): Nhẹ, Vừa, Nặng, Nghiêm trọng
        2. Đưa ra lời khuyên cụ thể, ngắn gọn (khoảng 100 từ)
        3. Gợi ý 3 bản nhạc phù hợp với trạng thái tâm lý, mỗi bản nhạc gồm: tên bài hát, nghệ sĩ, và lý do ngắn gọn tại sao phù hợp
        
        Định dạng kết quả phân tích dưới dạng JSON như sau:
        {
            "level": "Mức độ",
            "advice": "Lời khuyên",
            "musicRecommendations": [
                {
                    "title": "Tên bài hát",
                    "artist": "Nghệ sĩ",
                    "reason": "Lý do"
                },
                ...
            ]
        }`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        });
        
        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        const generatedText = data.candidates[0].content.parts[0].text;
        
        // Try to extract JSON from the response
        try {
            const jsonStart = generatedText.indexOf('{');
            const jsonEnd = generatedText.lastIndexOf('}') + 1;
            const jsonStr = generatedText.slice(jsonStart, jsonEnd);
            return JSON.parse(jsonStr);
        } catch (e) {
            console.error('Error parsing analysis JSON:', e);
            // Fallback to default analysis
            return {
                level: "Vừa",
                advice: "Bạn đang trải qua một số khó khăn về mặt tâm lý nhưng ở mức độ có thể kiểm soát được. Hãy dành thời gian chăm sóc bản thân, chia sẻ với người thân hoặc chuyên gia nếu cần thiết.",
                musicRecommendations: [
                    {
                        title: "Weightless",
                        artist: "Marconi Union",
                        reason: "Bài hát được khoa học chứng minh giúp giảm lo âu"
                    },
                    {
                        title: "Someone Like You",
                        artist: "Adele",
                        reason: "Giai điệu nhẹ nhàng giúp giải tỏa cảm xúc"
                    },
                    {
                        title: "Here Comes the Sun",
                        artist: "The Beatles",
                        reason: "Tạo cảm giác lạc quan và hy vọng"
                    }
                ]
            };
        }
    }
    
    function resetTest() {
        // Clear storage and reset state
        localStorage.removeItem('psychologyTest');
        currentQuestionIndex = 0;
        answers = [];
        questions = [];
        
        // Reset UI
        questionContainer.style.display = 'block';
        resultContainer.style.display = 'none';
        nextBtn.textContent = 'Tiếp theo';
        nextBtn.disabled = true;
        
        // Start new test
        generateNextQuestion();
        updateProgressBar();
    }
    
    function saveProgress() {
        const testData = {
            currentQuestionIndex: currentQuestionIndex,
            answers: answers,
            questions: questions
        };
        localStorage.setItem('psychologyTest', JSON.stringify(testData));
    }
    
    function showLoading(show) {
        if (show) {
            loadingIndicator.style.display = 'block';
            questionContainer.style.display = 'none';
        } else {
            loadingIndicator.style.display = 'none';
            questionContainer.style.display = 'block';
        }
    }
});
    </script>
</body>
</html>
